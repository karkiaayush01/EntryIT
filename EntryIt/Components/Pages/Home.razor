@page "/home"
@inject ThemeService ThemeService
@inject ILoggerService LoggerService
@inject IAuthService AuthService
@inject IMoodService MoodService
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject ToastService Toast

<div class="home-container">
    @if (IsSaveModalOpen)
    {
        <SaveJournalModal 
            IsOpen="IsSaveModalOpen"
            IsOpenChanged="SetIsSaveModelOpen" 
            OnSave="() => SetIsSaveModelOpen(false)"
            Moods="Moods"
        />
    }
    <div class="home-header">
        <h1 class="page-title">Home</h1>
        <div class="header-actions">
            <div class="streak-counter">
                <img src="assets/icons/fire.svg" alt="Streak" class="fire-icon" />
                <span class="streak-number">@currentUser?.CurrentStreak</span>
            </div>
            <div class="user-avatar">AK</div>
        </div>
    </div>

    <div class="home-content">
        <div class="journal-section">
            <div class="app-branding">
                <img src=@($"assets/app_logos/logo-{currentAccent}.svg") alt="Entry IT" class="app-logo" />
                <h2 class="app-name">Entry IT</h2>
            </div>

            <div class="journal-entry">
                <h3 class="journal-title">Today's Journal</h3>
                <div class="journal-input-wrapper">
                    <div 
                        id="editor"
                        style="height:200px;"
                    >
                    </div>
                    <button class="submit-btn" @onclick="() => SetIsSaveModelOpen(!IsSaveModalOpen)" disabled="@IsSaveDisabled()" title="Submit">
                        <img src="assets/icons/upload.svg" alt="Submit" class="submit-icon" />
                    </button>
                </div>
                 
            </div>
        </div>
    </div>
</div>

@code {
    private string journalEntry = "";
    private string currentAccent = string.Empty;
    private string HtmlContent = "";
    private string TextContent = "";
    private bool IsSaveModalOpen = false;
    public List<Mood> Moods = [];
    private UserViewModel? currentUser = null;
    private DotNetObjectReference<Home>? _objRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _objRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("initQuill", "editor");
            await JS.InvokeVoidAsync("quillInterop.registerOnChange", _objRef);
            var uri = new Uri(Nav.Uri);
            var queryParams = System.Web.HttpUtility.ParseQueryString(uri.Query);
            if (queryParams["from_login"] == "true")
            {
                Toast.Success("Login successful!");
            }
        }
    }

    [JSInvokable]
    public async Task OnEditorChanged()
    {
        HtmlContent = await JS.InvokeAsync<string>("getQuillHtml");
        TextContent = await JS.InvokeAsync<string>("getQuillText");

        LoggerService.LogInfo($"Content changed: {HtmlContent}");
        LoggerService.LogInfo($"Text Content changed: {TextContent}");
        LoggerService.LogInfo($"Should be disabled: {string.IsNullOrWhiteSpace(TextContent)}");
        StateHasChanged();
    }

    public bool IsSaveDisabled()
    {
        return string.IsNullOrWhiteSpace(TextContent);
    }

    public void SetIsSaveModelOpen(bool value)
    {
        IsSaveModalOpen = value;
        LoggerService.LogInfo($"Save model state: ${IsSaveModalOpen}");
    }

    private void SubmitJournal()
    {
        if (!string.IsNullOrWhiteSpace(journalEntry))
        {
            // Submit journal entry logic
            // Clear after submission
            journalEntry = "";
        }
    }

    protected async override Task OnInitializedAsync()
    {
        currentUser = AuthService.GetCurrentUser();

        var moodResult = await MoodService.GetMoods();
        if (moodResult.Success)
        {
            Moods = moodResult.Data ?? [];
        }

        currentAccent = ThemeService.GetCurrentAccent();
        ThemeService.OnChange += HandleThemeChanged;
    }

    private void HandleThemeChanged()
    {
        currentAccent = ThemeService.GetCurrentAccent();
        StateHasChanged();
    }

    public void Dispose()
    {
        _objRef?.Dispose();
        ThemeService.OnChange -= HandleThemeChanged;
    }
}
