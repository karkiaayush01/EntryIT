@inject ILoggerService LoggerService
@inject ITagService TagService
@inject ToastService Toast
@using System.Text.Json

<div class="tag-selector-overlay" @onclick="Close">
    <div class="tag-selector-container bg-dialog" @onclick:stopPropagation>
        <div class="tag-selector-header">
            <h3>Select Tags</h3>
            <button type="button" class="btn-close" @onclick="Close">√ó</button>
        </div>
        
        <div class="tag-selector-content">
            @foreach (var group in GetGroupedTags())
            {
                <div class="tag-group">
                    <div class="tag-group-header">
                        <span class="tag-group-icon">@GetGroupIcon(group.Key)</span>
                        <h4 class="tag-group-title">@GetGroupTitle(group.Key)</h4>
                        <span class="tag-group-count">@group.Value.Count</span>
                    </div>
                    
                    <div class="tag-grid">
                        @foreach (var tag in group.Value)
                        {
                            var isSelected = selectedTagIds.Contains(tag.Id);
                            <button type="button"
                                    class="tag-item @(isSelected ? "selected" : "")"
                                    @onclick="() => ToggleTag(tag)">
                                <span class="tag-name">@tag.Name</span>
                                @if (isSelected)
                                {
                                    <span class="tag-check selected-tab">‚úì</span>
                                }
                            </button>
                        }
                    </div>
                </div>
            }
            
            @if (!Tags.Any())
            {
                <div class="empty-state">
                    <span class="empty-icon">üè∑Ô∏è</span>
                    <p>No tags available</p>
                    <small>Tags will appear here once created</small>
                </div>
            }
        </div>

        @if (ShowCustomTagsForm)
        {
            <div class="add-custom-tag">
                <input 
                    type="text"
                    class="custom-tag-input bg-theme border-grey"
                    placeholder="Add Custom Tag..."
                    @bind-value="CustomTagName"
                    @bind-value:event="oninput" 
                />
                <Button 
                    Variant="ButtonVariant.Primary"
                    Icon="tag"
                    Text="Add Custom Tag"
                    OnClick="OnAddCustomTag"
                    Disabled="@(ValidationUtils.IsBlank(CustomTagName))" 
                />
            </div>
        }
        
        <div class="tag-selector-footer">
            <div class="selected-count">
                @selectedTagIds.Count selected
            </div>
            <div class="footer-actions">
                <Button Variant="ButtonVariant.Ghost" Text="Cancel" OnClick="Close" Style="font-weight: 600" />
                <Button Variant="ButtonVariant.Primary" Text="Add Tags" OnClick="ConfirmSelection" Style="font-weight: 600" />
            </div>
        </div>
    </div>
</div>

@code {

    [Parameter] public List<Tag> Tags { get; set; } = [];
    [Parameter] public List<Tag> SelectedTags { get; set; } = [];
    [Parameter] public EventCallback<List<Tag>> OnTagsSelected { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback<Tag> OnCustomTagAdded { get; set; }
    [Parameter] public bool ShowCustomTagsForm { get; set; } = false;

    private HashSet<Guid> selectedTagIds = new();
    private string CustomTagName { get; set; } = string.Empty;

    protected override void OnParametersSet()
    {
        selectedTagIds = SelectedTags.Select(t => t.Id).ToHashSet();
    }

    private Dictionary<string, List<Tag>> GetGroupedTags()
    {
        return Tags
            .GroupBy(t => t.Type)
            .OrderBy(g => g.Key == "pre-defined" ? 0 : 1)
            .ToDictionary(g => g.Key, g => g.OrderBy(t => t.Name).ToList());
    }

    private string GetGroupTitle(string type)
    {
        return type switch
        {
            "pre-defined" => "Pre-defined Tags",
            "custom" => "Custom Tags",
            _ => type
        };
    }

    private string GetGroupIcon(string type)
    {
        return type switch
        {
            "pre-defined" => "üìå",
            "custom" => "‚ú®",
            _ => "üè∑Ô∏è"
        };
    }

    private void ToggleTag(Tag tag)
    {
        if (selectedTagIds.Contains(tag.Id))
        {
            selectedTagIds.Remove(tag.Id);
        }
        else
        {
            selectedTagIds.Add(tag.Id);
        }
    }

    private async Task ConfirmSelection()
    {
        var selectedTags = Tags
            .Where(t => selectedTagIds.Contains(t.Id))
            .ToList();

        await OnTagsSelected.InvokeAsync(selectedTags);
        await Close();
    }

    private async Task OnAddCustomTag()
    {
        if (ValidationUtils.IsBlank(CustomTagName))
        {
            Toast.Error("Please enter a tag name");
            return;
        }

        if (Tags.Any(t => t.Name.Equals(CustomTagName, StringComparison.OrdinalIgnoreCase)))
        {
            Toast.Error("Tag already exists");
            return;
        }

        Toast.Info("Adding Tag");

        ServiceResult<Tag> result = await TagService.AddCustomTag(CustomTagName);

        if (result.Success && result.Data != null)
        {
            Toast.Success("Successfully Added Tag");
            CustomTagName = string.Empty;
            await OnCustomTagAdded.InvokeAsync(result.Data);
        }
        else
        {
            Toast.Error(result.ErrorMessage ?? "Failed to add tags");
        }
    }

    private async Task Close()
    {
        await OnClose.InvokeAsync();
    }
}
