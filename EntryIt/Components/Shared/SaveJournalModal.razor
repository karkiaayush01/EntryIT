<div class="save-journal-overlay" @onclick="HandleOverlayClick">
    <div class="save-container bg-dialog" @onclick:stopPropagation>
        <h2 class="text-primary">Save Journal</h2>
        <form @onsubmit="HandleSubmit" @onsubmit:preventDefault class="save-form">
            <div class="form-field">
                <label for="title" class="save-form-title">Journal Title</label>
                <input type="text" id="title" name="title" class="form-field-input" @bind="title" @bind:event="oninput" />
            </div>

            <div class="mood-containers">
                <div class="mood-field">
                    <label class="save-form-title">Primary Mood</label>
                    <div class="primary-mood">
                        @* <select @bind="primaryMood" class="mood-select">
                            @foreach (var mood in primaryMoods)
                            {
                                <option value="@mood.Value">@mood.Emoji @mood.Value</option>
                            }
                        </select> *@
                        <MoodSelector
                           Moods="Moods"
                           MoodType="primary"
                           SelectedMood="primaryMood"
                           OnMoodSelected="SetMood"
                        />
                    </div>
                </div>

                <div class="mood-field">
                    <label class="save-form-title">Secondary Moods</label>
                    <div class="secondary-moods">
                        <MoodSelector 
                            Moods="Moods"
                            MoodType="secondary1"
                            SelectedMood="secondaryMood1"
                            OnMoodSelected="SetMood" 
                        />
                        <MoodSelector 
                            Moods="Moods"
                            MoodType="secondary2"
                            SelectedMood="secondaryMood2"
                            OnMoodSelected="SetMood" 
                        />
                    </div>
                </div>
            </div>

            <div class="form-field">
                <label class="save-form-title">Tags</label>
                <div class="save-form-tags">
                    <div class="save-form-selected-tags">
                        @foreach (var tag in selectedTags)
                        {
                            <button type="button" class="tag-chip selected-tab" @onclick="() => RemoveTag(tag)">
                                @tag
                                <span class="tag-remove">×</span>
                            </button>
                        }
                    </div>
                    <button type="button" class="add-new-tags bg-primary" @onclick="ToggleTagInput">
                        <span class="plus-icon">+</span>
                    </button>
                </div>

                @if (showTagInput)
                {
                    <div class="tag-input-container">
                        <input type="text"
                               placeholder="Enter tag name"
                               @bind="newTag"
                               @bind:event="oninput"
                               @onkeyup="HandleTagKeyPress"
                               class="tag-input" />
                        <button type="button" class="btn-add-tag bg-primary" @onclick="AddTag">Add</button>
                    </div>
                }
            </div>

            <div class="lock-section">
                <div class="lock-switch">
                    <span>Lock Journal</span>
                    <label class="toggle-switch">
                        <input type="checkbox" @bind="isLocked" />
                        <span class="slider"></span>
                    </label>
                </div>

                @if (isLocked)
                {
                    <div class="form-field">
                        <label for="password" class="save-form-title">Journal Password</label>
                        <input type="password"
                               id="password"
                               name="password"
                               @bind="password"
                               @bind:event="oninput"
                               class="form-field-input"
                               placeholder="Enter password" />
                        <div class="checkbox-field">
                            <input type="checkbox"
                                   id="sameAsUser"
                                   @bind="sameAsUserPassword" />
                            <label for="sameAsUser">Same as user password</label>
                        </div>
                    </div>
                }
            </div>

            <button type="submit" class="btn-save bg-primary">Save Journal</button>
        </form>
    </div>
</div>

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback<bool> IsOpenChanged { get; set; }
    [Parameter] public EventCallback<JournalData> OnSave { get; set; }
    [Parameter] public List<Mood> Moods { get; set; } = [];

    private string title = string.Empty;
    private Mood? primaryMood = null;
    private Mood? secondaryMood1 = null;
    private Mood? secondaryMood2 = null;
    private List<string> selectedTags = new() { "Work", "Career", "Fitness" };
    private string newTag = string.Empty;
    private bool showTagInput = false;
    private bool isLocked = false;
    private string password = string.Empty;
    private bool sameAsUserPassword = false;

    protected override void OnParametersSet()
    {
        // Setting primaryMood to first mood if available and not already set
        if (Moods.Any() && primaryMood == null)
        {
            primaryMood = Moods.First();
        }
    }

    private readonly List<MoodOption> primaryMoods = new()
    {
        new("😊", "Happy"),
        new("😢", "Sad"),
        new("😡", "Angry"),
        new("😰", "Anxious"),
        new("😌", "Calm"),
        new("😴", "Tired")
    };

    private readonly List<MoodOption> secondaryMoods = new()
    {
        new("🎉", "Excited"),
        new("😎", "Confident"),
        new("🤔", "Thoughtful"),
        new("😓", "Stressed"),
        new("💪", "Motivated"),
        new("🥰", "Grateful")
    };

    private void HandleOverlayClick()
    {
        IsOpenChanged.InvokeAsync(false);
    }

    private void SetMood(MoodSelect moodSelect)
    {
        switch (moodSelect.Type.ToLower())
        {
            case "primary":
                primaryMood = moodSelect.Mood;
                break;
            case "secondary1":
                secondaryMood1 = moodSelect.Mood;
                break;
            case "secondary2":
                secondaryMood2 = moodSelect.Mood;
                break;
            default:
                throw new ArgumentException($"Invalid mood type: {moodSelect.Type}. Must be 'primary', 'secondary1', or 'secondary2'.");
        }
    }

    private void ToggleTagInput()
    {
        showTagInput = !showTagInput;
        if (showTagInput)
        {
            newTag = string.Empty;
        }
    }

    private void AddTag()
    {
        if (!string.IsNullOrWhiteSpace(newTag) && !selectedTags.Contains(newTag))
        {
            selectedTags.Add(newTag.Trim());
            newTag = string.Empty;
            showTagInput = false;
        }
    }

    private void RemoveTag(string tag)
    {
        selectedTags.Remove(tag);
    }

    private void HandleTagKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            AddTag();
        }
    }

    private async Task HandleSubmit()
    {
        var journalData = new JournalData
        {
            Title = title,
            PrimaryMood = primaryMood,
            SecondaryMoods = new List<Mood?>
            {
                secondaryMood1,
                secondaryMood2
            }.Where(m => m != null).ToList(),
            Tags = selectedTags,
            IsLocked = isLocked,
            Password = isLocked ? (sameAsUserPassword ? null : password) : null,
            UseSamePassword = sameAsUserPassword
        };

        await OnSave.InvokeAsync(journalData);
        await IsOpenChanged.InvokeAsync(false);
    }

    private record MoodOption(string Emoji, string Value);

    public class JournalData
    {
        public string Title { get; set; } = string.Empty;
        public Mood? PrimaryMood { get; set; } = null;
        public List<Mood?> SecondaryMoods { get; set; } = [];
        public List<string> Tags { get; set; } = new();
        public bool IsLocked { get; set; }
        public string? Password { get; set; }
        public bool UseSamePassword { get; set; }
    }
}
